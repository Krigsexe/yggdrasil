// YGGDRASIL Prisma Schema
// Database: PostgreSQL with pgvector extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================================================
// AUTHENTICATION (HEIMDALL)
// ============================================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         Role      @default(USER)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")

  // Metadata
  name         String?
  organization String?
  timezone     String?
  locale       String?

  // Relations
  refreshTokens RefreshToken[]
  memories      Memory[]
  checkpoints   Checkpoint[]
  auditLogs     AuditLog[]
  sessions      Session[]
  profile       Profile?

  @@map("users")
}

enum Role {
  USER
  ADMIN
  SYSTEM
}

model RefreshToken {
  id              String    @id @default(cuid())
  token           String    @unique
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt       DateTime  @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  revokedAt       DateTime? @map("revoked_at")
  replacedByToken String?   @map("replaced_by_token")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  metadata  Json?

  // Relations
  memories Memory[]

  @@index([userId])
  @@map("sessions")
}

// ============================================================================
// SOURCES (MIMIR, VOLVA, HUGIN)
// ============================================================================

model Source {
  id           String          @id @default(cuid())
  type         SourceType
  identifier   String
  url          String
  title        String
  authors      String[]
  publishedAt  DateTime?       @map("published_at")
  fetchedAt    DateTime        @default(now()) @map("fetched_at")
  trustScore   Int             @map("trust_score")
  branch       EpistemicBranch
  isValid      Boolean         @default(true) @map("is_valid")
  invalidatedAt DateTime?      @map("invalidated_at")

  // Extended metadata
  doi          String?
  isbn         String?
  issn         String?
  arxivId      String?         @map("arxiv_id")
  pubmedId     String?         @map("pubmed_id")
  abstract     String?
  keywords     String[]
  citations    Int?
  peerReviewed Boolean?        @map("peer_reviewed")
  journal      String?
  volume       String?
  issue        String?
  pages        String?

  // Semantic search embedding (pgvector)
  embedding          Unsupported("vector(1536)")? @map("embedding")
  embeddingUpdatedAt DateTime? @map("embedding_updated_at")

  // Relations
  validations ValidationSource[]

  @@unique([type, identifier])
  @@index([branch, trustScore])
  @@index([type])
  @@index([arxivId])
  @@index([pubmedId])
  @@map("sources")
}

enum SourceType {
  ARXIV
  PUBMED
  ISO
  RFC
  WIKIDATA
  WEB
  BOOK
  JOURNAL
  OTHER
}

enum EpistemicBranch {
  MIMIR
  VOLVA
  HUGIN
}

// ============================================================================
// VALIDATION (ODIN)
// ============================================================================

model Validation {
  id              String           @id @default(cuid())
  requestId       String           @map("request_id")
  content         String
  isValid         Boolean          @map("is_valid")
  confidence      Int
  rejectionReason RejectionReason? @map("rejection_reason")
  trace           Json
  processingTimeMs Int             @map("processing_time_ms")
  createdAt       DateTime         @default(now()) @map("created_at")

  // Relations
  sources ValidationSource[]

  @@index([requestId])
  @@index([isValid])
  @@map("validations")
}

model ValidationSource {
  id           String     @id @default(cuid())
  validationId String     @map("validation_id")
  validation   Validation @relation(fields: [validationId], references: [id], onDelete: Cascade)
  sourceId     String     @map("source_id")
  source       Source     @relation(fields: [sourceId], references: [id])

  @@unique([validationId, sourceId])
  @@map("validation_sources")
}

enum RejectionReason {
  NO_SOURCE
  CONTRADICTS_MEMORY
  FAILED_CRITIQUE
  NO_CONSENSUS
  INSUFFICIENT_CONFIDENCE
  CONTAMINATION_DETECTED
  TIMEOUT
  INTERNAL_ERROR
}

// ============================================================================
// COUNCIL (THING)
// ============================================================================

model Deliberation {
  id                  String          @id @default(cuid())
  requestId           String          @map("request_id")
  query               String
  finalProposal       String          @map("final_proposal")
  verdict             CouncilVerdict
  processingTimeMs    Int             @map("processing_time_ms")
  createdAt           DateTime        @default(now()) @map("created_at")

  // Relations
  responses    CouncilResponse[]
  challenges   LokiChallenge[]

  @@index([requestId])
  @@map("deliberations")
}

model CouncilResponse {
  id              String        @id @default(cuid())
  deliberationId  String        @map("deliberation_id")
  deliberation    Deliberation  @relation(fields: [deliberationId], references: [id], onDelete: Cascade)
  member          CouncilMember
  content         String
  confidence      Int
  reasoning       String?
  processingTimeMs Int          @map("processing_time_ms")
  createdAt       DateTime      @default(now()) @map("created_at")

  @@index([deliberationId])
  @@map("council_responses")
}

model LokiChallenge {
  id             String        @id @default(cuid())
  deliberationId String        @map("deliberation_id")
  deliberation   Deliberation  @relation(fields: [deliberationId], references: [id], onDelete: Cascade)
  targetMember   CouncilMember @map("target_member")
  challenge      String
  severity       ChallengeSeverity
  response       String?
  resolved       Boolean       @default(false)
  createdAt      DateTime      @default(now()) @map("created_at")

  @@index([deliberationId])
  @@map("loki_challenges")
}

enum CouncilMember {
  KVASIR
  BRAGI
  NORNES
  SAGA
  SYN
  LOKI
  TYR
}

enum CouncilVerdict {
  CONSENSUS
  MAJORITY
  SPLIT
  DEADLOCK
}

enum ChallengeSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// MEMORY (MUNIN)
// ============================================================================

model Memory {
  id                 String      @id @default(cuid())
  userId             String      @map("user_id")
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId          String?     @map("session_id")
  session            Session?    @relation(fields: [sessionId], references: [id])
  type               MemoryType
  content            Json
  embedding          Unsupported("vector(1536)")?

  // Metadata
  tags               String[]
  importance         Int         @default(50)
  accessCount        Int         @default(0) @map("access_count")
  lastAccessedAt     DateTime?   @map("last_accessed_at")

  // Lifecycle
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")
  validUntil         DateTime?   @map("valid_until")
  invalidatedAt      DateTime?   @map("invalidated_at")
  invalidatedBy      String?     @map("invalidated_by")
  invalidationReason String?     @map("invalidation_reason")

  // Relations
  dependsOn    MemoryDependency[] @relation("MemoryDependencies")
  dependents   MemoryDependency[] @relation("DependentMemories")

  @@index([userId, type])
  @@index([sessionId])
  @@index([createdAt])
  @@map("memories")
}

enum MemoryType {
  INTERACTION
  DECISION
  CORRECTION
  CHECKPOINT
  INVALIDATION
}

model MemoryDependency {
  id             String         @id @default(cuid())
  memoryId       String         @map("memory_id")
  memory         Memory         @relation("MemoryDependencies", fields: [memoryId], references: [id], onDelete: Cascade)
  dependsOnId    String         @map("depends_on_id")
  dependsOn      Memory         @relation("DependentMemories", fields: [dependsOnId], references: [id], onDelete: Cascade)
  dependencyType DependencyType @map("dependency_type")
  createdAt      DateTime       @default(now()) @map("created_at")

  @@unique([memoryId, dependsOnId])
  @@map("memory_dependencies")
}

enum DependencyType {
  DERIVES_FROM
  REFERENCES
  INVALIDATES
  SUPERSEDES
}

model Checkpoint {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String
  description String?
  stateHash   String   @map("state_hash")
  memoryIds   String[] @map("memory_ids")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("checkpoints")
}

// ============================================================================
// AUDIT (HEIMDALL)
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  resourceType String @map("resource_type")
  resourceId String?  @map("resource_id")
  method     String
  path       String
  statusCode Int      @map("status_code")
  durationMs Int      @map("duration_ms")
  ip         String?
  userAgent  String?  @map("user_agent")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([action])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// BIFROST - Chat UI (adapted from Chatbot UI)
// ============================================================================

model Profile {
  id                   String   @id @default(cuid())
  userId               String   @unique @map("user_id")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName          String?  @map("display_name")
  username             String   @unique
  bio                  String?
  imageUrl             String?  @map("image_url")
  hasOnboarded         Boolean  @default(false) @map("has_onboarded")
  openaiApiKey         String?  @map("openai_api_key")
  anthropicApiKey      String?  @map("anthropic_api_key")
  googleGeminiApiKey   String?  @map("google_gemini_api_key")
  mistralApiKey        String?  @map("mistral_api_key")
  groqApiKey           String?  @map("groq_api_key")
  perplexityApiKey     String?  @map("perplexity_api_key")
  azureOpenaiApiKey    String?  @map("azure_openai_api_key")
  openrouterApiKey     String?  @map("openrouter_api_key")
  useAzureOpenai       Boolean  @default(false) @map("use_azure_openai")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("profiles")
}

model Workspace {
  id                        String   @id @default(cuid())
  userId                    String   @map("user_id")
  name                      String
  description               String?
  isHome                    Boolean  @default(false) @map("is_home")
  defaultContextLength      Int      @default(4096) @map("default_context_length")
  defaultModel              String   @default("claude-3-5-sonnet-20241022") @map("default_model")
  defaultPrompt             String   @default("You are a helpful assistant.") @map("default_prompt")
  defaultTemperature        Float    @default(0.5) @map("default_temperature")
  includeProfileContext     Boolean  @default(true) @map("include_profile_context")
  includeWorkspaceInstructions Boolean @default(true) @map("include_workspace_instructions")
  instructions              String?
  embeddingsProvider        String   @default("openai") @map("embeddings_provider")
  imageUrl                  String?  @map("image_url")
  sharing                   String   @default("private")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  // Relations
  chats      Chat[]
  folders    Folder[]
  presets    Preset[]
  prompts    Prompt[]
  assistants Assistant[]
  files      File[]

  @@index([userId])
  @@map("workspaces")
}

model Folder {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  workspaceId String   @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name        String
  description String?
  type        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  chats    Chat[]
  presets  Preset[]
  prompts  Prompt[]
  files    File[]

  @@index([workspaceId])
  @@index([userId])
  @@map("folders")
}

model Chat {
  id                String    @id @default(cuid())
  userId            String    @map("user_id")
  workspaceId       String    @map("workspace_id")
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folderId          String?   @map("folder_id")
  folder            Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  assistantId       String?   @map("assistant_id")
  assistant         Assistant? @relation(fields: [assistantId], references: [id], onDelete: SetNull)
  name              String
  model             String?
  prompt            String?
  temperature       Float?
  contextLength     Int?      @map("context_length")
  includeProfileContext Boolean @default(true) @map("include_profile_context")
  includeWorkspaceInstructions Boolean @default(true) @map("include_workspace_instructions")
  embeddingsProvider String?  @map("embeddings_provider")
  sharing           String    @default("private")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  messages   Message[]
  chatFiles  ChatFile[]

  @@index([workspaceId])
  @@index([userId])
  @@index([folderId])
  @@map("chats")
}

model Message {
  id                 String   @id @default(cuid())
  chatId             String   @map("chat_id")
  chat               Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  userId             String   @map("user_id")
  assistantId        String?  @map("assistant_id")
  role               String   // user, assistant, system
  content            String
  model              String?
  imageUrls          String[] @map("image_urls")
  sequenceNumber     Int      @map("sequence_number")

  // YGGDRASIL metadata
  yggdrasilBranch    EpistemicBranch? @map("yggdrasil_branch")
  yggdrasilConfidence Int?            @map("yggdrasil_confidence")
  yggdrasilSources    Json?           @map("yggdrasil_sources")
  yggdrasilTrace      Json?           @map("yggdrasil_trace")
  yggdrasilRequestId  String?         @map("yggdrasil_request_id")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  messageFiles MessageFile[]

  @@index([chatId])
  @@index([userId])
  @@map("messages")
}

model Preset {
  id                        String    @id @default(cuid())
  userId                    String    @map("user_id")
  workspaceId               String    @map("workspace_id")
  workspace                 Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folderId                  String?   @map("folder_id")
  folder                    Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  name                      String
  description               String?
  model                     String
  prompt                    String
  temperature               Float
  contextLength             Int       @map("context_length")
  includeProfileContext     Boolean   @default(true) @map("include_profile_context")
  includeWorkspaceInstructions Boolean @default(true) @map("include_workspace_instructions")
  embeddingsProvider        String?   @map("embeddings_provider")
  sharing                   String    @default("private")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  @@index([workspaceId])
  @@index([userId])
  @@map("presets")
}

model Prompt {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folderId    String?   @map("folder_id")
  folder      Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  name        String
  content     String
  sharing     String    @default("private")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([workspaceId])
  @@index([userId])
  @@map("prompts")
}

model Assistant {
  id                        String    @id @default(cuid())
  userId                    String    @map("user_id")
  workspaceId               String    @map("workspace_id")
  workspace                 Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name                      String
  description               String?
  model                     String
  prompt                    String
  temperature               Float
  contextLength             Int       @map("context_length")
  includeProfileContext     Boolean   @default(true) @map("include_profile_context")
  includeWorkspaceInstructions Boolean @default(true) @map("include_workspace_instructions")
  embeddingsProvider        String?   @map("embeddings_provider")
  imageUrl                  String?   @map("image_url")
  sharing                   String    @default("private")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  // Relations
  chats              Chat[]
  assistantFiles     AssistantFile[]
  assistantTools     AssistantTool[]

  @@index([workspaceId])
  @@index([userId])
  @@map("assistants")
}

model File {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  workspaceId   String    @map("workspace_id")
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folderId      String?   @map("folder_id")
  folder        Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  name          String
  description   String?
  type          String
  filePath      String    @map("file_path")
  size          Int
  tokens        Int?
  sharing       String    @default("private")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  chatFiles      ChatFile[]
  messageFiles   MessageFile[]
  assistantFiles AssistantFile[]
  fileItems      FileItem[]

  @@index([workspaceId])
  @@index([userId])
  @@map("files")
}

model FileItem {
  id        String   @id @default(cuid())
  fileId    String   @map("file_id")
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  content   String
  tokens    Int
  localEmbedding Unsupported("vector(1536)")? @map("local_embedding")
  openaiEmbedding Unsupported("vector(1536)")? @map("openai_embedding")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([fileId])
  @@index([userId])
  @@map("file_items")
}

model ChatFile {
  id        String   @id @default(cuid())
  chatId    String   @map("chat_id")
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  fileId    String   @map("file_id")
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([chatId, fileId])
  @@map("chat_files")
}

model MessageFile {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fileId    String   @map("file_id")
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([messageId, fileId])
  @@map("message_files")
}

model AssistantFile {
  id          String    @id @default(cuid())
  assistantId String    @map("assistant_id")
  assistant   Assistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  fileId      String    @map("file_id")
  file        File      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([assistantId, fileId])
  @@map("assistant_files")
}

model Tool {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  name         String
  description  String?
  url          String
  customHeaders Json?   @map("custom_headers")
  schema       Json
  sharing      String   @default("private")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  assistantTools AssistantTool[]

  @@index([userId])
  @@map("tools")
}

model AssistantTool {
  id          String    @id @default(cuid())
  assistantId String    @map("assistant_id")
  assistant   Assistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  toolId      String    @map("tool_id")
  tool        Tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([assistantId, toolId])
  @@map("assistant_tools")
}

// ============================================================================
// HUGIN - Web Content (Internet Branch)
// ============================================================================

model WebContent {
  id          String    @id @default(cuid())
  url         String    @unique
  title       String
  content     String
  fetchedAt   DateTime  @map("fetched_at")
  trustScore  Int       @map("trust_score")
  domain      String
  language    String?
  author      String?
  publishedAt DateTime? @map("published_at")
  description String?
  warnings    String[]

  // Watch configuration
  watchId     String?   @map("watch_id")
  watch       WebWatch? @relation(fields: [watchId], references: [id], onDelete: SetNull)

  @@index([domain])
  @@index([trustScore])
  @@index([fetchedAt])
  @@map("web_content")
}

model WebWatch {
  id            String        @id @default(cuid())
  name          String
  url           String?
  domain        String?
  searchQuery   String?       @map("search_query")
  watchType     WebWatchType  @map("watch_type")
  intervalMs    Int           @map("interval_ms")
  isActive      Boolean       @default(true) @map("is_active")
  lastCheckedAt DateTime?     @map("last_checked_at")
  lastChangeAt  DateTime?     @map("last_change_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  content       WebContent[]

  @@index([isActive])
  @@map("web_watches")
}

enum WebWatchType {
  URL
  DOMAIN
  SEARCH
}
